#!/usr/bin/env bash
#
# Idempotent, tool‑aware installer for a developer environment.
# Templated by chezmoi using .chezmoidata/packages.yaml

set -euo pipefail
IFS=$'\n\t'

############################################
# Minimal UX helpers
############################################
# ASCII spinner shown while a long‑running
# command executes. Usage:
#     run_with_spinner "Doing stuff" cmd arg1 arg2
run_with_spinner() {
  local msg="$1"; shift
  local pid spin='-\|/'
  echo -ne "${msg} … "
  "$@" &>/tmp/spinner.log & pid=$!
  local i=0
  while kill -0 "$pid" 2>/dev/null; do
    printf "\r%s %s" "${msg}" "${spin:i++%${#spin}:1}"
    sleep 0.15
  done
  wait "$pid" && echo -e "\r${msg} … ✅" || {
    echo -e "\r${msg} … ❌  (details below)"; tail -40 /tmp/spinner.log; exit 1; }
}

echo "🚀  Starting unified developer environment setup…"

sudo -v

############################################
# Layer 1 – OS packages via dnf/apt
############################################
if command -v dnf >/dev/null 2>&1; then
  run_with_spinner "Layer 1: dnf base packages" bash -c \
    "sudo dnf install -y {{ .packages.dnf | join " " }}"
elif command -v apt-get >/dev/null 2>&1; then
  run_with_spinner "Layer 1: apt base packages" bash -c \
    "sudo apt-get update && sudo apt-get install -y {{ .packages.apt | join " " }}"
fi
############################################
# Layer 1.5 – CLI tools via Homebrew
############################################
if ! command -v brew >/dev/null 2>&1; then
  run_with_spinner "Install Homebrew" bash -c '
    sudo mkdir -p /home/linuxbrew/.linuxbrew && \
    sudo chown -R "$(whoami)" /home/linuxbrew/.linuxbrew && \
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
fi
# shellcheck disable=SC2046
# shellcheck disable=SC1091
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
run_with_spinner "brew update" brew update

run_with_spinner "brew install pkgs" brew install --formula --force-bottle {{ .packages.brew | join " " }} || \
  run_with_spinner "brew source build fallback" brew install {{ .packages.brew | join " " }}

############################################
# Layer 2 – Language toolchains
############################################
run_with_spinner "Install Rust toolchain" bash -c '
  if command -v rustc >/dev/null 2>&1; then exit 0; fi
  if command -v dnf >/dev/null 2>&1 && dnf list rust &>/dev/null; then
    sudo dnf install -y rust cargo
  else
    curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env" && rustup default stable
  fi'

run_with_spinner "Install Node (dnf/nvm)" bash -c '
  if command -v node >/dev/null 2>&1; then exit 0; fi
  if command -v dnf >/dev/null 2>&1 && dnf list nodejs &>/dev/null; then
    sudo dnf install -y nodejs
  else
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] || curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    # shellcheck disable=SC1090
    . "$NVM_DIR/nvm.sh" && nvm install --lts
  fi'

############################################
# Layer 2.5 – Shell Frameworks
############################################
run_with_spinner "Install Oh My Zsh framework" bash -c '
  # If the main script already exists, do nothing.
  if [ -f "$HOME/.oh-my-zsh/oh-my-zsh.sh" ]; then
    exit 0
  fi
  # Clone to a temporary directory.
  git clone --depth=1 https://github.com/ohmyzsh/ohmyzsh.git /tmp/ohmyzsh
  # Use rsync to merge the clone into the existing directory, overwriting nothing.
  rsync -a --ignore-existing /tmp/ohmyzsh/ "$HOME/.oh-my-zsh/"
  # Clean up the temporary clone.
  rm -rf /tmp/ohmyzsh'

############################################
# Layer 2.6 - External CLI Tools
############################################
run_with_spinner "Install Bitwarden CLI (bw)" bash -c '
  if command -v bw >/dev/null 2>&1; then exit 0; fi
  # Create a temp directory to work in
  cd /tmp
  # Download the official zip file
  curl -fLo bw.zip "https://vault.bitwarden.com/download/?app=cli&platform=linux"
  # Unzip it
  unzip -o bw.zip
  # Make it executable
  chmod +x ./bw
  # Move it to a directory in our PATH
  mv ./bw ~/.local/bin/
  # Clean up
  rm -f bw.zip'


############################################
# Layer 3 – Isolated CLIs (pipx & cargo)
############################################
run_with_spinner "pipx bootstrap" bash -c '
  if ! command -v pipx >/dev/null 2>&1; then
    python3 -m pip install --user pipx && python3 -m pipx ensurepath
  fi'

export PATH="$PATH:$HOME/.local/bin"
run_with_spinner "pipx install poetry & HF Hub" bash -c '
  pipx install --include-deps poetry || true
  pipx install --include-deps huggingface_hub || true'

# Rust standalone (zellij)
run_with_spinner "Ensure zellij" bash -c '
  if command -v zellij >/dev/null 2>&1; then exit 0; fi
  if command -v dnf >/dev/null 2>&1 && dnf list --quiet zellij &>/dev/null; then
    sudo dnf install -y zellij
  elif command -v brew >/dev/null 2>&1; then
    brew install zellij
  else
    cargo install zellij
  fi'

############################################
# Layer 4 – Zsh Plugins
############################################
ZSH_CUSTOM=${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}
PLUGINS_DIR="$ZSH_CUSTOM/plugins"

run_with_spinner "Install/Update zsh-autosuggestions" bash -c \
  "[ -d '$PLUGINS_DIR/zsh-autosuggestions' ] || git clone https://github.com/zsh-users/zsh-autosuggestions.git '$PLUGINS_DIR/zsh-autosuggestions'"

run_with_spinner "Install/Update zsh-syntax-highlighting" bash -c \
  "[ -d '$PLUGINS_DIR/zsh-syntax-highlighting' ] || git clone https://github.com/zsh-users/zsh-syntax-highlighting.git '$PLUGINS_DIR/zsh-syntax-highlighting'"

############################################
# Layer 4.5 – Zsh Theme
############################################
run_with_spinner "Install Powerlevel10k theme" bash -c \
  "[ -d '${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k' ] || git clone --depth=1 https://github.com/romkatv/powerlevel10k.git '${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k'"

############################################
# Final sanity – make sure /usr/bin/zsh exists *inside the toolbox*
############################################
fix_zsh_symlink() {
  local zsh_path="$1"
  if [[ -n "$zsh_path" && ! -e /usr/bin/zsh ]]; then
    sudo ln -sf "$zsh_path" /usr/bin/zsh
  fi
}

# If we are *already* in the toolbox just fix it;
# otherwise, try to jump in and fix it from the host.
if [[ -f /.toolboxenv || -f /.containerenv ]]; then
  run_with_spinner "Ensure /usr/bin/zsh exists" \
    fix_zsh_symlink "$(command -v zsh || true)"
elif command -v toolbox &>/dev/null && toolbox list -q | grep -q '^dev$'; then
  toolbox run dev bash -c 'fix_zsh_symlink "$(command -v zsh || true)"' || true
fi

echo "🎉  Environment bootstrap complete."
