#!/bin/bash
set -euo pipefail

echo "üîß Checking git configuration..."

# Target email from Bitwarden
TARGET_EMAIL="{{ range (bitwarden "item" "github.com").fields }}{{ if eq .name "noreply_email" }}{{ .value }}{{ end }}{{ end }}"
TARGET_NAME="jamespetran"
TARGET_SIGNING_KEY="21D39CC1D0B3B44A"

# Check current git config
CURRENT_EMAIL=$(git config --global user.email 2>/dev/null || echo "")
CURRENT_NAME=$(git config --global user.name 2>/dev/null || echo "")
CURRENT_SIGNING_KEY=$(git config --global user.signingkey 2>/dev/null || echo "")
CURRENT_GPG_SIGN=$(git config --global commit.gpgsign 2>/dev/null || echo "")

# Check if everything is already configured correctly
if [[ "$CURRENT_EMAIL" == "$TARGET_EMAIL" ]] && \
   [[ "$CURRENT_NAME" == "$TARGET_NAME" ]] && \
   [[ "$CURRENT_SIGNING_KEY" == "$TARGET_SIGNING_KEY" ]] && \
   [[ "$CURRENT_GPG_SIGN" == "true" ]]; then
  echo "‚úÖ Git configuration already correct. Skipping."
  exit 0
fi

echo "üìù Updating git configuration..."

# Set user information
if [[ "$CURRENT_NAME" != "$TARGET_NAME" ]]; then
  git config --global user.name "$TARGET_NAME"
  echo "  ‚úì Set user.name to $TARGET_NAME"
fi

if [[ "$CURRENT_EMAIL" != "$TARGET_EMAIL" ]]; then
  git config --global user.email "$TARGET_EMAIL"
  echo "  ‚úì Set user.email to $TARGET_EMAIL"
fi

# Set GPG signing
if [[ "$CURRENT_SIGNING_KEY" != "$TARGET_SIGNING_KEY" ]]; then
  git config --global user.signingkey "$TARGET_SIGNING_KEY"
  echo "  ‚úì Set signing key to $TARGET_SIGNING_KEY"
fi

if [[ "$CURRENT_GPG_SIGN" != "true" ]]; then
  git config --global commit.gpgsign true
  echo "  ‚úì Enabled GPG signing for commits"
fi

echo "‚úÖ Git configuration updated successfully."